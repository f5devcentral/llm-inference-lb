# Docker构建代理配置指南

## 概述

当您在企业网络环境或需要通过代理访问互联网时，Docker构建过程可能无法直接访问外部资源（如下载基础镜像、安装包等）。我们的脚本现在支持在构建时配置代理。

## 🚀 快速使用

### 使用您的代理地址
```bash
# 使用HTTP/HTTPS代理构建
./build-and-run.sh build --proxy http://127.0.0.1:8010

# 多平台构建使用代理
./build-and-run.sh buildx --proxy http://127.0.0.1:8010 --production
```

## 📋 代理参数说明

| 参数 | 说明 | 示例 |
|------|------|------|
| `--proxy URL` | 同时设置HTTP和HTTPS代理 | `--proxy http://127.0.0.1:8010` |
| `--http-proxy URL` | 仅设置HTTP代理 | `--http-proxy http://proxy.company.com:8080` |
| `--https-proxy URL` | 仅设置HTTPS代理 | `--https-proxy http://proxy.company.com:8080` |
| `--no-proxy HOSTS` | 不使用代理的主机列表 | `--no-proxy localhost,127.0.0.1,.local` |

## 🎯 使用场景

### 场景1：企业网络环境
```bash
# 企业代理服务器
./build-and-run.sh buildx --production \
  --proxy http://proxy.company.com:8080 \
  --no-proxy localhost,127.0.0.1,*.company.com \
  -t registry.company.com/f5-scheduler:v1.0
```

### 场景2：开发环境（您的情况）
```bash
# 本地代理
./build-and-run.sh build --proxy http://127.0.0.1:8010

# 多平台构建
./build-and-run.sh buildx --production \
  --proxy http://127.0.0.1:8010 \
  --platforms linux/amd64,linux/arm64 \
  --push -t localhost:6000/f5-scheduler:v1.0
```

### 场景3：不同协议使用不同代理
```bash
# HTTP和HTTPS使用不同代理
./build-and-run.sh buildx \
  --http-proxy http://http-proxy.company.com:8080 \
  --https-proxy http://https-proxy.company.com:8443 \
  --no-proxy localhost,127.0.0.1
```

## 🔧 技术原理

脚本会将代理设置作为构建参数传递给Docker：

```bash
# 实际执行的命令示例
docker buildx build \
  --build-arg HTTP_PROXY=http://127.0.0.1:8010 \
  --build-arg http_proxy=http://127.0.0.1:8010 \
  --build-arg HTTPS_PROXY=http://127.0.0.1:8010 \
  --build-arg https_proxy=http://127.0.0.1:8010 \
  -t f5-scheduler:latest .
```

### 环境变量说明
- `HTTP_PROXY` / `http_proxy`: HTTP协议代理
- `HTTPS_PROXY` / `https_proxy`: HTTPS协议代理  
- `NO_PROXY` / `no_proxy`: 不使用代理的主机列表

## 📝 Dockerfile兼容性

我们的Dockerfile已经支持代理参数，无需修改：

```dockerfile
# Dockerfile中会自动使用这些ARG
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG NO_PROXY
ARG http_proxy
ARG https_proxy
ARG no_proxy

# 在RUN命令中会自动生效
RUN apt-get update && apt-get install -y ...
RUN pip install -r requirements.txt
```

## 🚨 常见问题

### 1. 代理连接失败
```bash
# 检查代理是否可访问
curl -x http://127.0.0.1:8010 http://www.google.com

# 如果失败，检查代理配置
```

### 2. 部分域名不需要代理
```bash
# 使用no-proxy排除本地域名
./build-and-run.sh build \
  --proxy http://127.0.0.1:8010 \
  --no-proxy localhost,127.0.0.1,*.local,registry.company.com
```

### 3. 代理需要认证
```bash
# 代理URL中包含用户名密码
./build-and-run.sh build --proxy http://username:password@proxy.company.com:8080
```

## 🔍 调试技巧

### 查看实际执行的命令
脚本会显示完整的构建命令，包含代理参数：
```bash
执行命令: docker buildx build --build-arg HTTP_PROXY=http://127.0.0.1:8010 ...
```

### 在Dockerfile中调试代理
```dockerfile
# 临时添加到Dockerfile中查看代理设置
RUN echo "HTTP_PROXY=$HTTP_PROXY"
RUN echo "HTTPS_PROXY=$HTTPS_PROXY"
RUN curl -I http://www.google.com || echo "代理连接失败"
```

## 📚 完整示例

### 您的使用场景
```bash
# 1. 基本构建（开发版）
./build-and-run.sh build --proxy http://127.0.0.1:8010

# 2. 生产版构建
./build-and-run.sh build --production --proxy http://127.0.0.1:8010

# 3. 多平台构建
./build-and-run.sh buildx --production \
  --proxy http://127.0.0.1:8010 \
  --platforms linux/amd64,linux/arm64

# 4. 构建并推送到本地registry
./build-and-run.sh buildx --production \
  --proxy http://127.0.0.1:8010 \
  --push -t localhost:6000/f5-scheduler:v1.0

# 5. 运行容器
./build-and-run.sh run --f5-password your_password -t v1.0
```

## 💡 最佳实践

1. **测试代理连接**: 构建前先确认代理可用
2. **合理设置no-proxy**: 避免本地服务走代理
3. **使用环境变量**: 可以设置环境变量避免每次输入
   ```bash
   export HTTP_PROXY=http://127.0.0.1:8010
   export HTTPS_PROXY=http://127.0.0.1:8010
   ./build-and-run.sh build  # 会自动使用环境变量
   ```
4. **安全考虑**: 避免在命令行中暴露代理认证信息

现在您可以愉快地在代理环境下构建Docker镜像了！🎉 