# F5 LLM推理网关调度器 - 日志管理指南

## 📋 概述

本文档详细介绍F5 LLM推理网关调度器的日志管理机制，包括日志文件位置、自定义配置、生产环境的日志管理策略以及容器环境下的最佳实践。

## 🗂️ 日志文件分析

### 默认日志位置
- **默认文件名**: `scheduler.log`
- **默认位置**: 程序运行目录下
- **输出方式**: 同时输出到控制台和文件
- **日志级别**: 控制台和文件使用相同的配置级别（在`config/scheduler-config.yaml`中设置）
- **级别配置**: 通过`global.log_level`字段控制（DEBUG、INFO、WARNING、ERROR、CRITICAL）

### 日志配置支持

#### 配置文件设置
在 `config/scheduler-config.yaml` 中配置日志级别：
```yaml
global:
  # 日志级别配置（推荐使用此配置）
  # 可选值: DEBUG, INFO, WARNING, ERROR, CRITICAL
  # DEBUG: 显示所有级别日志
  # INFO: 显示 INFO, WARNING, ERROR, CRITICAL 级别日志  
  # WARNING: 仅显示 WARNING, ERROR, CRITICAL 级别日志
  # ERROR: 仅显示 ERROR, CRITICAL 级别日志
  # CRITICAL: 仅显示 CRITICAL 级别日志
  log_level: INFO
  
  # 向后兼容的调试开关（当未配置log_level时使用）
  # log_debug: True
```

#### 程序初始化
```python
# 程序启动时的日志配置
self.logger = init_logger(
    debug=self.config.global_config.log_debug,
    log_file=log_file_path,  # 支持自定义路径
    log_level=self.config.global_config.log_level  # 控制台和文件使用相同级别
)
```

**重要说明**：配置的日志级别会同时应用于控制台输出和文件输出，确保行为一致性。

## 🔧 自定义日志位置

### 1. 环境变量配置（推荐）
```bash
# 设置自定义日志文件路径
export LOG_FILE_PATH="/var/log/f5-scheduler/scheduler.log"

# 启用stdout输出（容器环境推荐）
export LOG_TO_STDOUT=true
export LOG_FILE_PATH=""
```

### 2. 代码级配置
修改 `main.py` 中的日志初始化部分：
```python
log_file_path = os.getenv('LOG_FILE_PATH', '/custom/path/scheduler.log')
```

## 🏭 生产环境日志管理策略

### 🐳 容器环境（Docker/Kubernetes）

#### 推荐方案：标准输出模式
**最简单、最推荐的方式**

**1. 设置环境变量**
```bash
# 关键配置：让日志输出到标准输出
export LOG_TO_STDOUT=true
```

**2. Docker运行**
```bash
docker run -d \
  --name f5-scheduler \
  -p 8080:8080 \
  -v $(pwd)/config/scheduler-config.yaml:/app/config/scheduler-config.yaml:ro \
  -e F5_PASSWORD=your-password \
  -e METRIC_PWD=your-metric-password \ #可选，非必须
  -e LOG_TO_STDOUT=true \
  --log-driver json-file \
  --log-opt max-size=100m \
  --log-opt max-file=3 \
  --restart unless-stopped \
  f5-scheduler:latest
```

**3. 查看和管理日志**
```bash
# 实时查看日志
docker logs -f f5-scheduler

# 导出日志到文件
docker logs f5-scheduler > scheduler-$(date +%Y%m%d).log

# 查看日志文件大小（Docker自动管理）
docker inspect f5-scheduler | grep -A 5 "LogConfig"
```

**4. Kubernetes配置**
```yaml
# 在Deployment中设置
env:
- name: LOG_TO_STDOUT
  value: "true"
- name: F5_PASSWORD
  valueFrom:
    secretKeyRef:
      name: f5-secrets
      key: password
- name: METRIC_PWD
  valueFrom:
    secretKeyRef:
      name: f5-secrets
      key: metric-pwd
```

**优点**：
- ✅ 无需管理日志文件
- ✅ Docker/K8s自动处理日志轮转
- ✅ 易于集成日志收集系统
- ✅ 符合云原生最佳实践

---

### 🖥️ 非容器环境（传统部署）

#### 推荐方案：文件日志 + 自动轮转

**1. 设置日志文件路径**
```bash
设置环境变量
export LOG_FILE_PATH="/var/log/f5-scheduler/scheduler.log"
```

**2. 创建日志目录**
```bash
# 创建日志目录
sudo mkdir -p /var/log/f5-scheduler

# 设置权限（假设程序以scheduler用户运行）
sudo chown scheduler:scheduler /var/log/f5-scheduler
sudo chmod 755 /var/log/f5-scheduler
```

**3. 配置自动日志轮转**
```bash
# 生成适配当前路径的logrotate配置
LOG_FILE_PATH="/var/log/f5-scheduler/scheduler.log" ./scripts/log-management.sh logrotate

# 安装logrotate配置
sudo cp /tmp/f5-scheduler-logrotate.conf /etc/logrotate.d/f5-scheduler

# 测试配置
sudo logrotate -d /etc/logrotate.d/f5-scheduler
```

**4. 设置定时任务**
```bash
# 编辑crontab
crontab -e

# 添加定时任务（每天凌晨2点执行日志管理）
0 2 * * * LOG_FILE_PATH="/var/log/f5-scheduler/scheduler.log" /opt/f5-scheduler/scripts/log-management.sh all
```

**5. 日常管理命令**
```bash
# 查看日志
tail -f /var/log/f5-scheduler/scheduler.log

# 检查日志状态
LOG_FILE_PATH="/var/log/f5-scheduler/scheduler.log" ./scripts/log-management.sh report

# 手动轮转（如果日志文件过大）
LOG_FILE_PATH="/var/log/f5-scheduler/scheduler.log" ./scripts/log-management.sh rotate

# 清理旧日志
LOG_FILE_PATH="/var/log/f5-scheduler/scheduler.log" ./scripts/log-management.sh cleanup
```

---

### 📋 快速配置检查清单

#### 容器环境检查
- [ ] 设置 `LOG_TO_STDOUT=true`
- [ ] 配置Docker日志驱动（`--log-opt max-size=100m --log-opt max-file=3`）
- [ ] 设置必需的环境变量（`F5_PASSWORD`）
- [ ] 可选：设置监控环境变量（`METRIC_PWD`）
- [ ] 挂载配置文件

#### 非容器环境检查  
- [ ] 设置 `LOG_FILE_PATH` 环境变量
- [ ] 创建日志目录并设置权限
- [ ] 生成并安装logrotate配置
- [ ] 设置定时任务
- [ ] 测试日志轮转

---

### 🚨 常见问题快速解决

#### 问题1: 容器中看不到日志
```bash
# 检查环境变量
docker inspect container-name | grep LOG_TO_STDOUT

# 如果没有设置，重新运行容器
docker rm -f container-name
docker run -e LOG_TO_STDOUT=true ...
```

#### 问题2: 非容器环境日志文件过大
```bash
# 立即轮转日志
LOG_FILE_PATH="/path/to/scheduler.log" ./scripts/log-management.sh rotate

# 检查logrotate配置
sudo logrotate -d /etc/logrotate.d/f5-scheduler
```

#### 问题3: 权限问题
```bash
# 检查日志文件权限
ls -la /var/log/f5-scheduler/

# 修复权限
sudo chown -R scheduler:scheduler /var/log/f5-scheduler/
```

---

### 🎯 环境变量配置总结

| 环境变量 | 容器环境 | 非容器环境 | 说明 |
|----------|----------|------------|------|
| `LOG_TO_STDOUT` | `true` | `false` | 控制日志输出方式 |
| `LOG_FILE_PATH` | 不设置 | `/var/log/f5-scheduler/scheduler.log` | 日志文件路径 |
| `F5_PASSWORD` | 必需 | 必需 | F5设备密码 |
| `METRIC_PWD` | 非必须 | 非必须 | 监控指标密码 |

这样配置后，容器环境下Docker会自动管理日志轮转，非容器环境下logrotate会自动处理日志文件，用户无需手动干预。 