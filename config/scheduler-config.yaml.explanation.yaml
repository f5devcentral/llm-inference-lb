# F5 LLM Inference Gateway Scheduler Configuration File
global:
  # Scheduler checks for configuration changes at this interval in seconds. The program will automatically hot reload.
  interval: 5
  # Scheduler API port for F5 sideband connection. Changing the port requires program restart.
  api_port: 8080
  # Scheduler API listening address for F5 sideband connection. Changing the address requires program restart.
  # 0.0.0.0: Listen on all network interfaces (default)
  # 127.0.0.1: Listen only on local loopback interface
  # Specific IP: Listen on specified network interface
  api_host: 0.0.0.0
  # Log level configuration (recommend using log_level)
  # Available values: DEBUG, INFO, WARNING, ERROR, CRITICAL
  # DEBUG: Show all level logs
  # INFO: Show INFO, WARNING, ERROR, CRITICAL level logs  
  # WARNING: Show only WARNING, ERROR, CRITICAL level logs
  # ERROR: Show only ERROR, CRITICAL level logs
  # CRITICAL: Show only CRITICAL level logs
  log_level: INFO
  # Backward compatibility debug switch (used when log_level is not configured)
  # log_debug: True

f5:
  host: 192.168.1.100
  port: 443
  username: admin
  # Environment variable for password, program needs to read environment variable and replace the value here
  password_env: F5_PASSWORD

scheduler:
  # Unit: seconds. This value should not be less than (metrics extraction timeout + 2) seconds, and should be as large as possible to avoid frequent F5 access.
  # Large intervals prevent the scheduler from timely learning about pool member changes, using old member information, but this doesn't affect F5 normal operation.
  # F5 will query the scheduler for the best node with the latest actual healthy member information, and the scheduler will select the best node based on the valid member information provided.
  # After F5 adds a new member, the scheduler won't calculate the new member's weight before the interval arrives, the scheduler will still select from old members. This gives the new member natural warm-up time.
  # After F5 removes a member, the scheduler still has the old member information before the interval arrives, but since it only looks for the best node among valid members provided from F5 sideband connection, the scheduler won't return the old member.
  pool_fetch_interval: 10
  # Unit: milliseconds. This value should maintain certain interval difference with fetch_interval to avoid conflicts between metrics collection objects and pool fetch objects (though uncommon).
  # Multiple pools use parallel collection, this value is the interval time for each round of collection. The actual maximum time for each round of collection is [this value + metrics collection timeout (default 3s)].
  # It's recommended to consult the inference engine administrator to understand the inference engine's own metrics update frequency. The corresponding matching setting (metrics_fetch_interval) should be appropriately smaller than the inference engine's metrics update frequency.
  metrics_fetch_interval: 3000

modes:
  # åŸå§‹ç®—æ³• - ä¸è¿›è¡Œcacheå½’ä¸€åŒ–
  - name: s1
    w_a: 0.2  # waiting_queue weight
    w_b: 0.8  # cache_usage weight
    
  # ç²¾ç¡®å½’ä¸€åŒ–ç®—æ³• - è§£å†³cacheå·®å¼‚ç²¾ç¡®åŒºåˆ†é—®é¢˜
  - name: s1_enhanced
    w_a: 0.2  # waiting_queue weight  
    w_b: 0.8  # cache_usage weight
    
  # æ¯”ä¾‹å½’ä¸€åŒ–ç®—æ³• - ç›´æ¥åŸºäºç›¸å¯¹æ¯”ä¾‹åˆ†é…
  - name: s1_ratio
    w_a: 0.2  # waiting_queue weight
    w_b: 0.8  # cache_usage weight
    
  # è‡ªé€‚åº”ç®—æ³• - åŠ¨æ€è°ƒæ•´æƒé‡
  - name: s1_adaptive  
    w_a: 0.2  # waiting_queue weight
    w_b: 0.8  # cache_usage weight
    
  # é«˜cacheæƒé‡é…ç½® - é€‚ç”¨äºwaiting_queueç»å¸¸ä¸º0çš„åœºæ™¯
  - name: s1_enhanced_high_cache
    w_a: 0.1  # waiting_queue weight
    w_b: 0.9  # cache_usage weight
    
  # éçº¿æ€§æ”¾å¤§ç®—æ³• - è§£å†³å¾®å°å·®å¼‚åŒºåˆ†é—®é¢˜(ChatGPTå»ºè®®)
  - name: s1_nonlinear
    w_a: 0.2  # waiting_queue weight
    w_b: 0.8  # cache_usage weight
    power: 2.0  # éçº¿æ€§æ”¾å¤§å¹‚æ¬¡
  
  # åŸå§‹S2ç®—æ³•
  #- name: s2
  #  w_a: 0.6  # Weight for waiting queue metric
  #  w_b: 0.2  # Weight for cache usage metric
  #  w_g: 0.2  # Weight for running requests metric
  
  # S2å¢å¼ºç®—æ³• - å¯¹cacheè¿›è¡Œå½’ä¸€åŒ–ä»¥æé«˜åŒºåˆ†åº¦
  #- name: s2_enhanced
  #  w_a: 0.4  # Weight for waiting queue metric (é™ä½ï¼Œå› ä¸ºç»å¸¸ä¸º0)
  #  w_b: 0.4  # Weight for cache usage metric (æé«˜ï¼Œå¢å¼ºåŒºåˆ†åº¦)
  #  w_g: 0.2  # Weight for running requests metric
    
  # å¯é€‰ï¼šS2éçº¿æ€§ç®—æ³• - ä½¿ç”¨æŒ‡æ•°å˜æ¢æ”¾å¤§å·®å¼‚
  #- name: s2_nonlinear
  #  w_a: 0.4  # Weight for waiting queue metric
  #  w_b: 0.4  # Weight for cache usage metric
  #  w_g: 0.2  # Weight for running requests metric
    
  # å¯é€‰ï¼šS2è‡ªé€‚åº”ç®—æ³• - æ ¹æ®æŒ‡æ ‡å˜å¼‚ç³»æ•°åŠ¨æ€è°ƒæ•´æƒé‡
  #- name: s2_adaptive
  #  w_a: 0.4  # Base weight for waiting queue metric
  #  w_b: 0.4  # Base weight for cache usage metric
  #  w_g: 0.2  # Base weight for running requests metric
    
  # ğŸ†• å¹³è¡¡ç®—æ³• - ä¸“é—¨è§£å†³ä¸¤èŠ‚ç‚¹å½’ä¸€åŒ–æå€¼é—®é¢˜
  - name: s1_balanced
    w_a: 0.3
    w_b: 0.7

  # æ–°å¢ï¼šè‡ªé€‚åº”åˆ†å¸ƒå½’ä¸€åŒ–ç®—æ³• - æ•°å­¦ä¸“å®¶é‡æ–°è®¾è®¡çš„æ™®é€‚ç®—æ³•
  - name: s1_adaptive_distribution
    w_a: 0.2
    w_b: 0.8

  # ğŸš€ ç»ˆæç®—æ³•ï¼šS1è‡ªé€‚åº”åˆ†å¸ƒå½’ä¸€åŒ–+åŠ¨æ€æƒé‡ - æ•°å­¦ä¸Šæœ€ä¼˜è§£
  - name: s1_advanced
    w_a: 0.2  # åŸºç¡€æƒé‡ï¼Œä¼šæ ¹æ®å˜å¼‚ç³»æ•°åŠ¨æ€è°ƒæ•´
    w_b: 0.8  # åŸºç¡€æƒé‡ï¼Œä¼šæ ¹æ®å˜å¼‚ç³»æ•°åŠ¨æ€è°ƒæ•´
    
  # ğŸš€ ç»ˆæç®—æ³•ï¼šS2è‡ªé€‚åº”åˆ†å¸ƒå½’ä¸€åŒ–+åŠ¨æ€æƒé‡ - ä¸‰æŒ‡æ ‡æœ€ä¼˜è§£
  - name: s2_advanced
    w_a: 0.4  # waiting_queueåŸºç¡€æƒé‡
    w_b: 0.4  # cache_usageåŸºç¡€æƒé‡  
    w_g: 0.2  # running_reqåŸºç¡€æƒé‡

  # ğŸ¯ æ™ºèƒ½åŠ¨æ€waitingæƒé‡ç®—æ³• - è§£å†³waiting requesté‡è¦æ€§åŠ¨æ€å˜åŒ–é—®é¢˜
  
  # åŠ¨æ€waitingæƒé‡ï¼ˆåŒæŒ‡æ ‡ç‰ˆæœ¬ï¼‰ - æœ€æ™®é€‚çš„æ™ºèƒ½æƒé‡è°ƒæ•´ç®—æ³•  
  - name: s1_dynamic_waiting
    w_a: 0.3  # waiting_queueåŸºç¡€æƒé‡
    w_b: 0.7  # cache_usageåŸºç¡€æƒé‡
    transition_point: 30  # è¿‡æ¸¡ç‚¹ï¼š30ä¸ªç­‰å¾…è¯·æ±‚ï¼ˆå¯æ ¹æ®ç¯å¢ƒè°ƒæ•´ï¼‰
    steepness: 1.0       # é™¡å³­åº¦ï¼šæ§åˆ¶è¿‡æ¸¡å¹³æ»‘ç¨‹åº¦ï¼ˆå¯è°ƒæ•´ï¼‰
    
    # ğŸ“Š ç®—æ³•åŸç†ï¼š
    # ä½¿ç”¨tanhæ•°å­¦å‡½æ•°å®ç°å¹³æ»‘çš„æƒé‡è¿‡æ¸¡ï¼Œé¿å…ç¡¬é˜ˆå€¼çªå˜
    # intensity = tanh(max_waiting * steepness / transition_point)
    # 
    # ğŸ”„ æƒé‡å˜åŒ–èŒƒå›´ï¼š
    # - æ— ç­‰å¾…æ—¶ï¼ˆmax_waiting=0ï¼‰ï¼š0.2Ã—waiting + 1.8Ã—cacheï¼ˆä¸»è¦é cacheåŒºåˆ†ï¼‰
    # - è½»åº¦ç­‰å¾…æ—¶ï¼ˆmax_waiting=15ï¼‰ï¼šçº¦0.8Ã—waiting + 1.2Ã—cacheï¼ˆå¼€å§‹å¹³è¡¡ï¼‰
    # - é‡åº¦ç­‰å¾…æ—¶ï¼ˆmax_waitingâ‰¥60ï¼‰ï¼š2.5Ã—waiting + 0.3Ã—cacheï¼ˆä¸»è¦é waitingåŒºåˆ†ï¼‰
    #
    # âš™ï¸ å‚æ•°è°ƒä¼˜æŒ‡å—ï¼š
    # - transition_point: è°ƒæ•´è¿‡æ¸¡çš„ä¸­å¿ƒç‚¹
    #   * ä½è´Ÿè½½ç¯å¢ƒï¼šå»ºè®®15-20
    #   * é«˜è´Ÿè½½ç¯å¢ƒï¼šå»ºè®®30-50
    # - steepness: è°ƒæ•´è¿‡æ¸¡çš„é™¡å³­ç¨‹åº¦  
    #   * éœ€è¦å¿«é€Ÿå“åº”ï¼šå»ºè®®1.5-2.0
    #   * éœ€è¦å¹³ç¼“è¿‡æ¸¡ï¼šå»ºè®®0.5-1.0
    #
    # âœ… é€‚ç”¨åœºæ™¯ï¼šæ‰€æœ‰vLLM/SGLangç­‰æ¨ç†å¼•æ“ç¯å¢ƒï¼ˆåŒæŒ‡æ ‡ï¼‰
    
  # åŠ¨æ€waitingæƒé‡ï¼ˆä¸‰æŒ‡æ ‡ç‰ˆæœ¬ï¼‰ - é€‚ç”¨äºæœ‰running_reqæŒ‡æ ‡çš„åœºæ™¯
  - name: s2_dynamic_waiting
    w_a: 0.4  # waiting_queueåŸºç¡€æƒé‡
    w_b: 0.3  # cache_usageåŸºç¡€æƒé‡  
    w_g: 0.3  # running_reqåŸºç¡€æƒé‡
    transition_point: 30  # è¿‡æ¸¡ç‚¹ï¼š30ä¸ªç­‰å¾…è¯·æ±‚ï¼ˆå¯æ ¹æ®ç¯å¢ƒè°ƒæ•´ï¼‰
    steepness: 1.0       # é™¡å³­åº¦ï¼šæ§åˆ¶è¿‡æ¸¡å¹³æ»‘ç¨‹åº¦ï¼ˆå¯è°ƒæ•´ï¼‰
    
    # ğŸ“Š ä¸‰æŒ‡æ ‡åŠ¨æ€è°ƒæ•´åŸç†ï¼š
    # intensity = tanh(max_waiting * steepness / transition_point)
    # 
    # ğŸ”„ ä¸‰æŒ‡æ ‡æƒé‡å˜åŒ–èŒƒå›´ï¼š
    # - æ— ç­‰å¾…æ—¶ï¼ˆmax_waiting=0ï¼‰ï¼š0.1Ã—waiting + 1.5Ã—cache + 1.4Ã—runningï¼ˆä¸»è¦é cacheå’ŒrunningåŒºåˆ†ï¼‰
    # - è½»åº¦ç­‰å¾…æ—¶ï¼ˆmax_waiting=15ï¼‰ï¼šçº¦1.0Ã—waiting + 1.0Ã—cache + 1.0Ã—runningï¼ˆä¸‰æŒ‡æ ‡å¹³è¡¡ï¼‰
    # - é‡åº¦ç­‰å¾…æ—¶ï¼ˆmax_waitingâ‰¥60ï¼‰ï¼š2.5Ã—waiting + 0.4Ã—cache + 0.6Ã—runningï¼ˆä¸»è¦é waitingåŒºåˆ†ï¼‰
    #
    # âœ… é€‚ç”¨åœºæ™¯ï¼šæ‰€æœ‰æ”¯æŒrunning_reqæŒ‡æ ‡çš„æ¨ç†å¼•æ“ç¯å¢ƒï¼ˆä¸‰æŒ‡æ ‡ï¼‰

pools:
  - name: example_pool1
    partition: Common
    engine_type: vllm
    metrics:
      schema: http
      #port: 30000
      path: /metrics
      timeout: 4  # HTTP request timeout (seconds)
      APIkey: abcdefdfdsfds
      metric_user: user1
      metric_pwd_env: METRIC_PWD
  - name: example_pool2
    partition: Common
    engine_type: sglang
    metrics:
      schema: http
      #port: 30001
      path: /metrics
      timeout: 4  # HTTP request timeout (seconds)
      APIkey: abcdef
      metric_user: user1
      metric_pwd_env: METRIC_PWD